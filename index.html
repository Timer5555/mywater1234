<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Water Meter Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap');
    body { font-family: 'Sarabun', sans-serif; }
    .hidden { display: none; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="container mx-auto p-6 max-w-4xl">
    <!-- Header -->
    <header class="mb-8 flex justify-between items-center">
      <h1 class="text-3xl font-bold text-blue-600">üíß Water Meter Hub</h1>
      <div id="user-info" class="hidden">
        <span id="user-email" class="mr-4 text-slate-600"></span>
        <button id="logout-btn" class="text-blue-600">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </header>

    <!-- Loading -->
    <div id="loading-indicator" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

    <!-- Login -->
    <div id="auth-view" class="max-w-md mx-auto bg-white p-6 rounded shadow hidden">
      <h2 class="text-xl font-bold mb-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
      <div id="auth-error" class="text-red-600 mb-3 hidden"></div>
      <form id="login-form" class="space-y-3">
        <input id="login-email" type="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full border p-2 rounded" required>
        <input id="login-password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full border p-2 rounded" required>
        <button class="w-full bg-blue-600 text-white py-2 rounded">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </form>
    </div>

    <!-- Main -->
    <div id="app-content" class="hidden">
      <!-- Houses -->
      <div id="house-list-view">
        <div class="flex justify-between mb-4">
          <h2 class="text-xl font-semibold">üè† ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</h2>
          <button id="add-house-btn" class="bg-blue-600 text-white px-4 py-2 rounded">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡πâ‡∏≤‡∏ô</button>
        </div>
        <div id="house-list-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
        <p id="no-houses-message" class="text-center text-slate-500 hidden">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡πâ‡∏≤‡∏ô</p>
      </div>

      <!-- House Detail -->
      <div id="house-detail-view" class="hidden">
        <button id="back-to-list-btn" class="text-blue-600 mb-3">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2 id="house-detail-name" class="text-2xl font-bold mb-3"></h2>
        <button id="add-reading-btn" class="bg-blue-600 text-white px-4 py-2 rounded mb-4">+ ‡∏à‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå</button>
        <div id="chart-section" class="mb-6 hidden">
          <canvas id="usage-chart" height="150"></canvas>
        </div>
        <table class="w-full border text-left">
          <thead class="bg-slate-100">
            <tr><th class="p-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-2">‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå</th><th class="p-2">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÉ‡∏ä‡πâ</th></tr>
          </thead>
          <tbody id="readings-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Add House -->
  <div id="add-house-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded shadow w-full max-w-sm">
      <h3 class="text-lg font-bold mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡πâ‡∏≤‡∏ô</h3>
      <form id="add-house-form">
        <input id="house-name-input" type="text" class="w-full border p-2 mb-3" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô" required>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal(addHouseModal)" class="px-3 py-1 bg-gray-300 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="px-3 py-1 bg-blue-600 text-white rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Add Reading -->
  <div id="add-reading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded shadow w-full max-w-sm">
      <h3 class="text-lg font-bold mb-3">‡∏à‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå</h3>
      <form id="add-reading-form" class="space-y-3">
        <input id="add-reading-date" type="date" class="w-full border p-2" required>
        <input id="add-reading-value" type="number" class="w-full border p-2" placeholder="‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå" required>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal(addReadingModal)" class="px-3 py-1 bg-gray-300 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="px-3 py-1 bg-blue-600 text-white rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // üëâ URL ‡∏Ç‡∏≠‡∏á Web App ‡∏à‡∏≤‡∏Å Apps Script
    const API_URL = "https://script.google.com/macros/s/AKfycbzoAmyK4zCsAqntP8iPde-ZlWTGoSoUB5inmLyOted2-dtwiFlS-doAcGpIwFXE5Rh_/exec";

    let currentUser=null, houses=[], selectedHouseId=null, usageChart=null;

    // API call
    async function callAPI(action, payload={}) {
      console.log("callAPI ->", action, payload);
      const res = await fetch(API_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ action, ...payload })
      });
      const data = await res.json();
      console.log("API response:", data);
      return data;
    }

    // UI update
    function updateUI(user){
      document.getElementById("loading-indicator").classList.add("hidden");
      if(user){
        document.getElementById("auth-view").classList.add("hidden");
        document.getElementById("app-content").classList.remove("hidden");
        document.getElementById("user-info").classList.remove("hidden");
        document.getElementById("user-email").textContent=user.email;
        loadHouses();
      }else{
        document.getElementById("auth-view").classList.remove("hidden");
        document.getElementById("app-content").classList.add("hidden");
        document.getElementById("user-info").classList.add("hidden");
      }
    }

    // Login
    async function handleLogin(e){
      e.preventDefault();
      const email=document.getElementById("login-email").value.trim();
      const password=document.getElementById("login-password").value.trim();
      console.log("Sending login:", email, password);

      const result=await callAPI("login",{email,password});
      console.log("Login result:", result);

      if(result.success){ currentUser={email}; updateUI(currentUser);}
      else{ const err=document.getElementById("auth-error"); err.textContent="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"; err.classList.remove("hidden"); }
    }

    function handleLogout(){ currentUser=null; updateUI(null); }

    // Houses
    async function loadHouses(){
      const result=await callAPI("getHouses",{email:currentUser.email});
      houses=result||[];
      const list=document.getElementById("house-list-container");
      list.innerHTML="";
      if(houses.length===0){document.getElementById("no-houses-message").classList.remove("hidden");}
      else{
        document.getElementById("no-houses-message").classList.add("hidden");
        houses.forEach(h=>{
          const card=document.createElement("div");
          card.className="bg-white p-4 rounded shadow cursor-pointer";
          card.innerHTML=`<h3 class="font-bold">${h.name}</h3>`;
          card.onclick=()=>openHouse(h.id);
          list.appendChild(card);
        });
      }
    }

    async function handleAddHouse(e){
      e.preventDefault();
      const name=document.getElementById("house-name-input").value.trim();
      if(!name)return;
      await callAPI("addHouse",{email:currentUser.email,houseName:name});
      closeModal(addHouseModal); loadHouses();
    }

    // Readings
    async function openHouse(houseId){
      selectedHouseId=houseId;
      const readings=await callAPI("getReadings",{houseId});
      const house=houses.find(h=>h.id===houseId);
      house.readings=readings||[];
      renderHouseDetail(house);
    }

    function renderHouseDetail(house){
      document.getElementById("house-list-view").classList.add("hidden");
      document.getElementById("house-detail-view").classList.remove("hidden");
      document.getElementById("house-detail-name").textContent=house.name;
      const tbody=document.getElementById("readings-table-body"); tbody.innerHTML="";
      let prev=0; const sorted=[...house.readings].sort((a,b)=>new Date(a.date)-new Date(b.date)); const usageData=[];
      sorted.forEach(r=>{
        const usage=prev? r.value-prev:0; prev=r.value;
        usageData.push({date:r.date,usage,value:r.value});
        tbody.innerHTML+=`<tr><td class="p-2">${r.date}</td><td class="p-2">${r.value}</td><td class="p-2">${usage}</td></tr>`;
      });
      if(usageData.length>1){
        document.getElementById("chart-section").classList.remove("hidden");
        const ctx=document.getElementById("usage-chart"); if(usageChart)usageChart.destroy();
        usageChart=new Chart(ctx,{type:"line",data:{labels:usageData.map(r=>r.date),datasets:[{label:"‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ",data:usageData.map(r=>r.usage),borderColor:"#2563eb"}]}});
      }
    }

    async function handleAddReading(e){
      e.preventDefault();
      const date=document.getElementById("add-reading-date").value;
      const value=parseInt(document.getElementById("add-reading-value").value);
      await callAPI("addReading",{houseId:selectedHouseId,date,value,imageUrl:""});
      closeModal(addReadingModal); openHouse(selectedHouseId);
    }

    // Modals
    const addHouseModal=document.getElementById("add-house-modal");
    const addReadingModal=document.getElementById("add-reading-modal");
    function openModal(m){m.classList.remove("hidden");}
    function closeModal(m){m.classList.add("hidden");}

    // Event bindings
    document.getElementById("login-form").addEventListener("submit",handleLogin);
    document.getElementById("logout-btn").addEventListener("click",handleLogout);
    document.getElementById("add-house-btn").addEventListener("click",()=>openModal(addHouseModal));
    document.getElementById("add-house-form").addEventListener("submit",handleAddHouse);
    document.getElementById("back-to-list-btn").addEventListener("click",()=>{
      document.getElementById("house-list-view").classList.remove("hidden");
      document.getElementById("house-detail-view").classList.add("hidden");
    });
    document.getElementById("add-reading-btn").addEventListener("click",()=>{
      document.getElementById("add-reading-date").value=new Date().toISOString().split("T")[0];
      openModal(addReadingModal);
    });
    document.getElementById("add-reading-form").addEventListener("submit",handleAddReading);

    updateUI(null); lucide.createIcons();
  </script>
</body>
</html>
